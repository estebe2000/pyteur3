"use strict";(self.webpackChunk_basthon_basthon_console=self.webpackChunk_basthon_basthon_console||[]).push([[577],{1838:(t,e,s)=>{s.d(e,{EH:()=>a,JQ:()=>i,Te:()=>c,t:()=>l});class a extends Error{constructor(t){super(`Function ${t} not implemented!`),this.name="NotImplementedError"}}const n=async t=>await new Promise(((e,s)=>{const a=new FileReader;a.onloadend=()=>{e(a.result)},a.onerror=s,a.readAsDataURL(new Blob([t]))})),o=async(t,e)=>{const s=t,a=e.slice(s.length);let o=null;const r={status:200,statusText:"OK",headers:new Headers};try{o=await self.basthon.getFile(a);const t=await n(o),e=t.substring(t.indexOf(":")+1,t.indexOf(";"));o=o.buffer,r.headers.append("Content-Type",e),r.headers.append("Content-Length",o.byteLength)}catch(t){r.status=404,r.statusText="Not Found"}return new Response(o,r)},r=t=>new URL(t).origin,i=t=>{if("mockedFetch"===self.fetch.name)return;const e=self.fetch,s=self._assetsURL;self.fetch=async function(a,n){const i=(a=new Request(a,n)).url,l="filesystem:/";if(t)return i.startsWith(l)?await o(l,i):await e(a);if(null==self.importScripts||null==s)return Response.error();a=new Request(a,{credentials:"omit"});try{if(i.startsWith(l))return await o(l,i);if(r(i)===r(s)){if((t=>{const e=new URL(t).href;return e.substring(0,e.lastIndexOf("/"))})(i).startsWith(s)){const t=self._remoteProxy,{body:e,options:s}=await t.fetch(a);return new Response(e,s)}throw new Error("Ressource is outside the proxy' scope")}return await e(a)}catch(t){return console.error(`security proxy: request to ${i} throw error: ${t.toString()}`),Response.error()}}},l=()=>{if("SandboxedWorker"!==globalThis.Worker.name){class t extends Worker{constructor(t,e){if(!0===e?.sandboxed){const e=new URL(t).href,s=`\n           self._assetsURL = "${e.substring(0,e.lastIndexOf("/"))}";\n           globalThis = {importScripts: self.importScripts, location: "${t}"};\n           importScripts("${t}");\n           globalThis = self;\n        `.replace(/\s/g,"");super(`data:text/javascript;base64,${btoa(s)}`)}else super(t,e)}}globalThis.Worker=t}},c=()=>{if(null==globalThis?.HTMLImageElement)return;const t=Object.getOwnPropertyDescriptor(HTMLImageElement.prototype,"src");"mockedSrcSet"!==t?.set?.name&&Object.defineProperty(HTMLImageElement.prototype,"src",{...t,get:function(){return t?.get?.call(this)},set:function(e){if(e.startsWith("filesystem:/")){const s=e.slice(12);(async()=>{const e=(await(globalThis.Basthon?.getFile?.(s)))?.buffer;t?.set?.call(this,await n(e))})()}else t?.set?.call(this,e)}})}},2577:(t,e,s)=>{s.d(e,{f:()=>l});var a=s(9610),n=s(1838),o=s(4590),r=s(1236),i=s(9365);class l{constructor(t){this._ready=new a.D,this._evalPromises=[],this._decrypt=t=>t,this._options=t,this._legacy=!0===t?.legacy,this._basthonRoot=self._assetsURL+"/"+r.x+"/"+this.language(),(0,n.JQ)(this.isLegacy()),self.basthon=this,null==self.window&&(self.window=self),self.Canvas=this.isLegacy()?function(t,e){const s=document.createElement("canvas");return null!=t&&(s.width=t),null!=e&&(s.height=e),s}:globalThis.OffscreenCanvas,null==self._prompt&&(self._prompt=globalThis.prompt),globalThis.prompt=t=>this.input(t),this.isLegacy()&&(this._domNodeBus=new i.fA),self._assetsURL=void 0}language(){throw new n.EH("language")}isLegacy(){return this._legacy}basthonRoot(){return this._basthonRoot}syncCommSupport(){return null!=this._sab}async legacyStart(){throw new n.EH("legacyStart")}async legacyStop(){throw new n.EH("legacyStop")}setSAB(t){this._sab=t}addEvalPromise(t){this._evalPromises.push(t)}async setFallbackKeyAndPass(t,e){this._fallbackKey=t;const a=await Promise.all([s.e(955),s.e(396),s.e(858)]).then(s.t.bind(s,1396,23));this._decrypt=t=>a.AES.decrypt(t,e).toString(a.enc.Utf8)}async _init(){}async init(){try{await this._init(),this._ready.resolve()}catch(t){throw this._ready.reject(t),t}}ready(){return this._ready.promise}setCommPort(t){this.postMessage=t.postMessage.bind(t),t.onmessage=t=>this.processMainThreadMessage(t.data)}setProxyPort(t){self._remoteProxy=(0,o.LV)(t)}sendStream(t,e,s){this.postMessage?.({data:t,type:"stream",content:{stream:e,text:s}})}sendStdoutStream(t,e){this.sendStream(t,"stdout",e)}sendStderrStream(t,e){this.sendStream(t,"stderr",e)}async blobToDataURL(t){return await new Promise((e=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.readAsDataURL(t)}))}async displayBlob(t,e){null==e&&(e=this.clone(this.__eval_data__));const s=await this.blobToDataURL(t);if(s.startsWith("data:image/png;base64,")){{const t=s.slice(22);e.display_type="multiple",e.content={"image/png":t}}this.postMessage?.({data:e,type:"display"})}}display(t){const e=this.clone(this.__eval_data__);null!=globalThis.OffscreenCanvas&&t instanceof OffscreenCanvas?this.addEvalPromise((async()=>{const s=await t.convertToBlob();await this.displayBlob(s,e)})()):(this.isLegacy()&&t instanceof HTMLElement?(e.display_type="dom-node",e.content=this._domNodeBus?.push?.(t)):(e.display_type="multiple",e.content=t),this.postMessage?.({data:e,type:"display"}))}clearOutput(t){const e=this.clone(this.__eval_data__);e.content={wait:t},this.postMessage?.({data:e,type:"clear_output"})}popDOMNode(t){return this._domNodeBus?.pop(t)}async _eval(t,e){throw new n.EH("_eval")}async eval(t,e){let s;this._evalPromises=[],this.__eval_data__=t;try{s={data:t,status:"ok",result:await this._eval(t,e)}}catch(e){const{name:a,stack:n,message:o}=e;this.sendStderrStream(t,e.toString()),s={data:t,status:"error",error:{name:a,value:o,traceback:n?.toString()}}}return this.postMessage?.({type:"eval-end"}),await Promise.all(this._evalPromises),s}putFile(t,e){throw new n.EH("putFile")}putModule(t,e){throw new n.EH("putModule")}async complete(t){return[]}async more(t){throw new n.EH("more")}download(t,e){this.postMessage?.({type:"download",content:{content:t,filename:e}})}clone(t){return JSON.parse(JSON.stringify(t))}sleep(t){if(t*=1e3,this.syncCommSupport())return Atomics.store(new Int32Array(this._sab),0,0),void Atomics.wait(new Int32Array(this._sab),0,0,t);{const e=Date.now();for(;Date.now()-e<t;);}}decodeSharedArrayBuffer(t){const e=new Uint8Array(t);let s=e.length;for(;s>0&&0===e[s-1];s--);if(0===s)return"";const a=new Uint8Array(s);a.set(e.subarray(0,s));try{return(new TextDecoder).decode(a)}catch(t){if(e.length===s)throw new Error("String too long, can't decode");throw t}}input(t,e=!1){const s=()=>{const s=this.clone(this.__eval_data__);this.postMessage?.({type:"input",content:{data:s,prompt:t,password:e}})};if(this.syncCommSupport())return s(),Atomics.store(new Int32Array(this._sab),0,0),Atomics.wait(new Int32Array(this._sab),0,0),this.decodeSharedArrayBuffer(this._sab);if(null!=self._prompt)return self._prompt(t??"")??"";{s();const t=12e4,e=Date.now()+t;for(;Date.now()<e;){const t=new XMLHttpRequest;if(t.open("POST","https://api.basthon.fr/ephemeral",!1),t.setRequestHeader("X-API-Referer",this._basthonRoot??"null"),t.send(JSON.stringify({action:"get",key:this._fallbackKey})),200===t.status)return this._decrypt(t.responseText)}throw new Error("Error using the Basthon's network API")}}async processMainThreadMessage(t){"toplevel-input"===t.type&&this._toplevelInputPromise?.resolve(t.content)}async toplevelInput(t,e=!1,s=void 0){this._toplevelInputPromise=new a.D,this.postMessage?.({type:"input",content:{data:s,prompt:t,password:e,toplevel:!0}});const n=await this._toplevelInputPromise.promise;return this._toplevelInputPromise=void 0,n}breakpointMoveOn(){const t=this.clone(this.__eval_data__);this.postMessage?.({type:"breakpoint-move-on",content:{data:t}})}displayKernelIFrame(t){const{port1:e,port2:s}=new MessageChannel,a={html:t,port:e},n={...this.clone(this.__eval_data__),content:a,display_type:"kernel-iframe"};return this.postMessage?.({data:n,type:"display"},[e]),s}}},9365:(t,e,s)=>{s.d(e,{fA:()=>o,k0:()=>r,p:()=>n});var a=s(4590);const n=t=>{if("undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope){const e=s=>{s?.data instanceof MessagePort&&(removeEventListener("message",e),(0,a.p)(t,s.data))};addEventListener("message",e)}else(0,a.p)(t,self._commPort),self._commPort=void 0};class o extends Map{push(t){let e=0;for(;e<this.size&&this.has(e);e++);return this.set(e,t),e}pop(t){const e=this.get(t);return this.delete(t),e}}const r=async t=>null!=globalThis.importScripts?importScripts(t):new Promise(((e,s)=>{const a=document.createElement("script");a.onload=e,a.onerror=s,a.src=t,document.head.appendChild(a)}))}}]);
//# sourceMappingURL=577.5b10c005bcaeaf71279d.js.map