{% extends "base.html" %}

{% block title %}Gestion des Documents{% endblock %}
{% block page_title %}Documents{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('main.home') }}">Accueil</a> > Documents
{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h2 class="text-xl font-semibold">Vos documents</h2>
    <button onclick="document.getElementById('uploadModal').classList.remove('hidden')"
        class="btn btn-primary flex-1 py-2 px-4 rounded-lg shadow bg-blue-600 text-white hover:bg-blue-700 transition max-w-xs">
        <i class="fas fa-upload mr-2"></i> Uploader
    </button>
</div>

<div class="bg-white rounded-xl shadow-sm overflow-hidden">
    {% if documents %}
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tags</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for doc in documents %}
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <i class="fas fa-file-pdf text-red-500 mr-2"></i>
                        <a href="{{ url_for('static', filename='uploads/' + doc.filename) }}" 
                           target="_blank" class="text-blue-600 hover:underline">
                            {{ doc.original_filename }}
                        </a>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ doc.tags }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ doc.created_at.strftime('%d/%m/%Y') }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <a href="{{ url_for('static', filename='uploads/' + doc.filename) }}" target="_blank" class="btn btn-primary flex-1 py-2 px-4 rounded-lg shadow bg-blue-600 text-white hover:bg-blue-700 transition mr-2">
                        <i class="fas fa-eye"></i> Voir
                    </a>
                    <button onclick="confirmDelete('{{ doc.id }}')" 
                            class="text-red-600 hover:text-red-900 mr-3">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="p-8 text-center text-gray-500">
        <i class="fas fa-folder-open text-4xl mb-2"></i>
        <p>Aucun document trouvé</p>
    </div>
    {% endif %}
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Uploader un document</h3>
            <button onclick="document.getElementById('uploadModal').classList.add('hidden')"
                class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
<form method="POST" action="{{ url_for('main.upload_file') }}" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="mb-4">
        <label class="block text-gray-700 mb-2">Fichier PDF</label>
        <input type="file" name="file" accept=".pdf" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md">
    </div>
    <div class="mb-4">
        <label class="block text-gray-700 mb-2">Tags (séparés par des virgules)</label>
        <input type="text" name="tags" placeholder="maths, devoir, 2023"
            class="w-full px-3 py-2 border border-gray-300 rounded-md">
    </div>
    <button type="submit" class="btn btn-primary w-full">
        Uploader
    </button>
</form>
    </div>
</div>

<script>
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function confirmDelete(docId) {
    if (confirm('Supprimer ce document ?')) {
        fetch('/delete/' + docId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrf_token')
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}
</script>
{% endblock %}
