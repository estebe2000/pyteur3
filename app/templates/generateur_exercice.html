{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>{{ labels['exercise_generator'] }}</h2>
    <p><strong>IA :</strong> {{ ia_name }} | <strong>Modèle :</strong> {{ model_name }}</p>

    <div class="mt-4">
        <h5>{{ labels['choose_level'] }} :</h5>
        <div id="niveauContainer" class="grid-container mt-2"></div>
    </div>

    <div class="mt-4">
        <h5>{{ labels['choose_theme'] }} :</h5>
        <div id="themeContainer" class="grid-container mt-2"></div>
    </div>

    <div class="mt-4">
        <h5>{{ labels['choose_difficulty'] }} :</h5>
        <div id="difficulteContainer" class="mt-2">
            {% for i in range(1,6) %}
            <span class="star" data-value="{{ i }}">&#9734;</span>
            {% endfor %}
        </div>
    </div>

    <div class="mt-4">
        <h5>{{ labels['exercise_description'] }} :</h5>
        <p id="descriptionExercice">{{ labels['select_all_fields'] }}</p>
    </div>

    <div class="my-4">
        <button id="genererBtn" class="btn btn-primary flex-1 py-2 px-4 rounded-lg shadow bg-blue-600 text-white hover:bg-blue-700 transition max-w-xs" disabled>
            {{ labels['generate_with_ai'] }}
        </button>
    </div>

    <div class="my-4">
        <h5>{{ labels['used_prompt'] }} :</h5>
        <pre id="promptAffiche" style="white-space: pre-wrap; background:#eef; padding:10px; border-radius:5px; border:1px solid #99f;"></pre>
    </div>

    <div class="my-4">
        <h5>{{ labels['generated_exercise'] }} :</h5>
        <pre id="resultatIA" style="white-space: pre-wrap; background:#f8f9fa; padding:10px; border-radius:5px; border:1px solid #ccc;"></pre>
    </div>
</div>

<style>
.grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
}

.btn-choice {
    padding: 10px 15px;
    border: 1px solid #007bff;
    border-radius: 5px;
    background-color: white;
    color: #007bff;
    cursor: pointer;
    transition: 0.3s;
    text-align: center;
}
.btn-choice:hover {
    background-color: #007bff;
    color: white;
}
.btn-choice.active {
    background-color: #007bff;
    color: white;
}

.star {
    font-size: 2rem;
    color: #ccc;
    cursor: pointer;
    transition: color 0.2s;
}
.star:hover,
.star:hover ~ .star {
    color: #ffc107;
}
.star.selected {
    color: #ffc107;
}
</style>

<script>
let data = {};
let selectedNiveau = null;
let selectedTheme = null;
let selectedDifficulte = 0;

async function chargerData() {
    try {
        const response = await fetch('/api/generateur_data');
        data = await response.json();

        const niveauContainer = document.getElementById('niveauContainer');
        niveauContainer.innerHTML = '';

        const ordreNiveaux = ["Troisième", "SNT", "Première", "Terminale"];

        ordreNiveaux.forEach(niveau => {
            if (data[niveau]) {
                const btn = document.createElement('div');
                btn.className = 'btn-choice';
                btn.textContent = niveau;
                btn.dataset.value = niveau;
                btn.addEventListener('click', () => {
                    selectedNiveau = niveau;
                    selectedTheme = null;
                    selectedDifficulte = 0;
                    updateSelection();
                    afficherThemes();
                    updateDescription();
                });
                niveauContainer.appendChild(btn);
            }
        });

        // Ajouter les autres niveaux non listés explicitement
        Object.keys(data).forEach(niveau => {
            if (!ordreNiveaux.includes(niveau)) {
                const btn = document.createElement('div');
                btn.className = 'btn-choice';
                btn.textContent = niveau;
                btn.dataset.value = niveau;
                btn.addEventListener('click', () => {
                    selectedNiveau = niveau;
                    selectedTheme = null;
                    selectedDifficulte = 0;
                    updateSelection();
                    afficherThemes();
                    updateDescription();
                });
                niveauContainer.appendChild(btn);
            }
        });
    } catch (error) {
        console.error('Erreur chargement données:', error);
    }
}

function afficherThemes() {
    const themeContainer = document.getElementById('themeContainer');
    themeContainer.innerHTML = '';
    if (!selectedNiveau || !data[selectedNiveau]) return;

    data[selectedNiveau].forEach(themeObj => {
        const btn = document.createElement('div');
        btn.className = 'btn-choice';
        btn.textContent = themeObj.thème;
        btn.dataset.value = themeObj.thème;
        btn.addEventListener('click', () => {
            selectedTheme = themeObj.thème;
            selectedDifficulte = 0;
            updateSelection();
            updateDescription();
        });
        themeContainer.appendChild(btn);
    });
}

function updateSelection() {
    document.querySelectorAll('#niveauContainer .btn-choice').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === selectedNiveau);
    });
    document.querySelectorAll('#themeContainer .btn-choice').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === selectedTheme);
    });
    document.querySelectorAll('.star').forEach(star => {
        const val = parseInt(star.dataset.value);
        if (val <= selectedDifficulte) {
            star.classList.add('selected');
        } else {
            star.classList.remove('selected');
        }
    });
}

function updateDescription() {
    const descriptionExercice = document.getElementById('descriptionExercice');
    const genererBtn = document.getElementById('genererBtn');

    if (selectedNiveau && selectedTheme && selectedDifficulte && data[selectedNiveau]) {
        const themeObj = data[selectedNiveau].find(t => t.thème === selectedTheme);
        if (themeObj) {
            const nivObj = themeObj.niveaux.find(n => n.niveau === selectedDifficulte);
            if (nivObj) {
                descriptionExercice.textContent = nivObj.description;
                genererBtn.disabled = false;
                return;
            }
        }
    }
    descriptionExercice.textContent = '{{ labels['select_all_fields'] }}';
    genererBtn.disabled = true;
}

document.addEventListener('DOMContentLoaded', () => {
    chargerData();

    document.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', () => {
            selectedDifficulte = parseInt(star.dataset.value);

            document.querySelectorAll('.star').forEach(s => {
                if (parseInt(s.dataset.value) <= selectedDifficulte) {
                    s.classList.add('selected');
                } else {
                    s.classList.remove('selected');
                }
            });

            updateDescription();
        });
    });

    document.getElementById('genererBtn').addEventListener('click', async () => {
        const niveau = selectedNiveau;
        const theme = selectedTheme;
        const difficulte = selectedDifficulte;
        const description = document.getElementById('descriptionExercice').textContent;

        const resultatIA = document.getElementById('resultatIA');
        const promptAffiche = document.getElementById('promptAffiche');

        resultatIA.textContent = "{{ labels['generating'] }}";
        promptAffiche.textContent = "{{ labels['building_prompt'] }}";

        try {
            // Récupérer la valeur debutant depuis le JSON pédagogique
            let debutant = false;
            if (data[niveau]) {
                const themeObj = data[niveau].find(t => t.thème === theme);
                if (themeObj && themeObj.niveaux) {
                    const niveauObj = themeObj.niveaux.find(n => n.niveau === difficulte);
                    if (niveauObj && typeof niveauObj.debutant !== 'undefined') {
                        debutant = niveauObj.debutant;
                    }
                }
            }

            const responsePrompt = await fetch('/api/generer_exercice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    niveau: niveau,
                    theme: theme,
                    difficulte: difficulte,
                    description: description,
                    debutant: debutant
                })
            });
            const dataPrompt = await responsePrompt.json();

            if (dataPrompt.error) {
                promptAffiche.textContent = "{{ labels['error_generating_prompt'] }} " + dataPrompt.error;
                resultatIA.textContent = "";
                return;
            }

            promptAffiche.textContent = dataPrompt.prompt || "{{ labels['prompt_unavailable'] }}";
            resultatIA.textContent = dataPrompt.response || "{{ labels['response_unavailable'] }}";
        } catch (error) {
            promptAffiche.textContent = "";
            resultatIA.textContent = "{{ labels['request_error'] }} " + error;
        }
    });
});
</script>
{% endblock %}
