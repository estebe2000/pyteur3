{% extends "base.html" %}

{% block title %}Gestion des devoirs{% endblock %}
{% block page_title %}Gestion des devoirs{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('dashboard.home') }}">{{ labels['home'] }}</a> {{ labels['breadcrumb_separator'] }} Gestion des devoirs
{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold">Ajouter un nouveau devoir</h2>
    </div>

    <form method="POST" action="{{ url_for('misc.add_homework') }}" class="bg-white p-6 rounded-lg shadow-md mb-8">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Titre du devoir *</label>
                <input type="text" id="title" name="title" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div>
                <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Matière</label>
                <input type="text" id="subject" name="subject" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
        </div>
        
        <div class="mb-4">
            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea id="description" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="due_date" class="block text-sm font-medium text-gray-700 mb-1">Date limite *</label>
                <input type="date" id="due_date" name="due_date" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div>
                <label for="assignment_type" class="block text-sm font-medium text-gray-700 mb-1">Assigner à *</label>
                <select id="assignment_type" name="assignment_type" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="toggleAssignmentFields()">
                    <option value="">Sélectionner...</option>
                    <option value="class">Classe entière</option>
                    <option value="group">Groupe</option>
                </select>
            </div>
        </div>
        
        <div id="class_field" class="hidden mb-4">
            <label for="class_id" class="block text-sm font-medium text-gray-700 mb-1">Classe</label>
            <select id="class_id" name="class_id" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <option value="">Sélectionner une classe...</option>
                {% for class in classes %}
                <option value="{{ class.id }}">{{ class.niveau }} {{ class.nom }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div id="group_field" class="hidden mb-4">
            <label for="group_id" class="block text-sm font-medium text-gray-700 mb-1">Groupe</label>
            <select id="group_id" name="group_id" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <option value="">Sélectionner un groupe...</option>
                {% for group in groups %}
                <option value="{{ group.id }}">{{ group.nom }} ({{ group.school_class.niveau }} {{ group.school_class.nom }})</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="flex justify-end">
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Ajouter le devoir</button>
        </div>
    </form>

    <h2 class="text-xl font-semibold mb-4">Devoirs assignés</h2>
    
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-200">
            <thead>
                <tr>
                    <th class="py-2 px-4 border-b text-left">Titre</th>
                    <th class="py-2 px-4 border-b text-left">Matière</th>
                    <th class="py-2 px-4 border-b text-left">Date limite</th>
                    <th class="py-2 px-4 border-b text-left">Assigné à</th>
                    <th class="py-2 px-4 border-b text-left">Assigné par</th>
                    <th class="py-2 px-4 border-b text-left">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for homework in homework_list %}
                <tr class="hover:bg-gray-50">
                    <td class="py-2 px-4 border-b">{{ homework.title }}</td>
                    <td class="py-2 px-4 border-b">{{ homework.subject or '-' }}</td>
                    <td class="py-2 px-4 border-b">{{ homework.due_date.strftime('%d/%m/%Y') }}</td>
                    <td class="py-2 px-4 border-b">
                        {% if homework.class_id %}
                            Classe: {{ homework.school_class.niveau }} {{ homework.school_class.nom }}
                        {% elif homework.group_id %}
                            Groupe: {{ homework.group.nom }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="py-2 px-4 border-b">{{ homework.assigned_by.prenom }} {{ homework.assigned_by.nom }}</td>
                    <td class="py-2 px-4 border-b">
                        <div class="flex space-x-2">
                            <a href="{{ url_for('misc.edit_homework', homework_id=homework.id) }}" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit"></i>
                            </a>
                            <form method="POST" action="{{ url_for('misc.delete_homework', homework_id=homework.id) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce devoir?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="py-4 px-4 text-center text-gray-500">Aucun devoir assigné pour le moment.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function toggleAssignmentFields() {
        const assignmentType = document.getElementById('assignment_type').value;
        const classField = document.getElementById('class_field');
        const groupField = document.getElementById('group_field');
        
        if (assignmentType === 'class') {
            classField.classList.remove('hidden');
            groupField.classList.add('hidden');
            document.getElementById('group_id').value = '';
        } else if (assignmentType === 'group') {
            groupField.classList.remove('hidden');
            classField.classList.add('hidden');
            document.getElementById('class_id').value = '';
        } else {
            classField.classList.add('hidden');
            groupField.classList.add('hidden');
        }
    }
</script>
{% endblock %}
