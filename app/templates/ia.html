{% extends "base.html" %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block title %}{{ labels['ai_title'] }}{% endblock %}

{% block page_title %}{{ labels['ai_title'] }}{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('dashboard.home') }}">{{ labels['home'] }}</a> {{ labels['breadcrumb_separator'] }} {{ labels['ai_title'] }}
{% endblock %}

{% block content %}
<div class="container mx-auto px-4">

<h2 class="text-2xl font-bold mb-4">{{ labels['ai_providers'] }}</h2>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 border rounded bg-gray-50">
        <h3 class="font-semibold mb-2">{{ labels['ollama_local'] }}</h3>
        <div id="ollama-status" class="mb-2 text-sm"></div>
        <label class="block mb-2">{{ labels['ollama_url'] }} :</label>
        <div class="flex items-center mb-2">
            <input id="ollama-url" type="text" class="flex-grow border p-2 rounded" value="http://localhost:11434">
            <button onclick="refreshOllama()" title="Valider et rafraÃ®chir" class="ml-2 px-3 py-2 bg-green-600 text-white rounded">
                ðŸ”„
            </button>
        </div>
        <label class="block mb-2">{{ labels['ollama_model'] }} :</label>
        <select id="ollama-model" class="w-full border p-2 rounded mb-2"></select>
        <button onclick="saveOllama()" class="px-4 py-2 bg-blue-600 text-white rounded">{{ labels['activate_ollama'] }}</button>

        <div class="mt-4">
            <label class="block mb-2">{{ labels['model_name_to_download'] }} :</label>
            <input id="ollama-pull-model" type="text" class="w-full border p-2 rounded mb-2" placeholder="ex: mistral:7b">
            <button onclick="pullOllamaModel()" class="px-4 py-2 bg-green-600 text-white rounded">{{ labels['download_model'] }}</button>
        </div>
    </div>

    <div class="p-4 border rounded bg-gray-50">
        <h3 class="font-semibold mb-2">{{ labels['mistral_codestral'] }}</h3>
        <label class="block mb-2">{{ labels['api_url'] }} :</label>
        <input id="mistral-url" type="text" class="w-full border p-2 rounded mb-2" value="https://codestral.mistral.ai/v1/chat/completions">
        <label class="block mb-2">{{ labels['api_key'] }} :</label>
        <input id="mistral-key" type="text" class="w-full border p-2 rounded mb-2">
        <button onclick="saveMistral()" class="px-4 py-2 bg-blue-600 text-white rounded">{{ labels['activate_mistral'] }}</button>
    </div>
</div>

<div id="status" class="text-green-600 mb-4"></div>

<h2 class="text-2xl font-bold mb-4">{{ labels['chat_ai'] }}</h2>

<div class="mt-6">
    <textarea id="user-input" rows="4" class="w-full p-2 border rounded" placeholder="{{ labels['write_question_placeholder'] }}"></textarea>
    <button id="send-btn" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded">{{ labels['send'] }}</button>
</div>

<div id="response" class="mt-4 p-4 border rounded bg-gray-100"></div>

</div>

<script>
async function detectOllama() {
    const statusDiv = document.getElementById('ollama-status');
    const select = document.getElementById('ollama-model');
    statusDiv.innerText = '{{ labels['detecting'] }}';
    select.innerHTML = '';
    try {
        const res = await fetch('/api/ollama_status');
        const data = await res.json();
        if (data.installed) {
            statusDiv.innerHTML = '<span class="text-green-600">{{ labels['ollama_detected'] }}</span>';
            data.models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m;
                select.appendChild(opt);
            });
        } else {
            statusDiv.innerHTML = '<span class="text-red-600">{{ labels['ollama_not_detected'] }} <a href="https://ollama.com/download" target="_blank" class="underline">ollama.com</a></span>';
        }
    } catch {
        statusDiv.innerText = '{{ labels['error_detecting'] }}';
    }
}

async function saveOllama() {
    const url = document.getElementById('ollama-url').value.trim();
    const model = document.getElementById('ollama-model').value.trim();
    const config = {
        active_provider: "ollama",
        ollama: { url, model }
    };
    console.log("Envoi config Ollama:", config);
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const res = await fetch('/api/save_ia_config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(config)
    });
    if (res.ok) {
        document.getElementById('status').innerText = '{{ labels['ollama_config_saved'] }}';
    } else {
        document.getElementById('status').innerText = '{{ labels['save_error'] }}';
    }
}

async function saveMistral() {
    const url = document.getElementById('mistral-url').value.trim();
    const api_key = document.getElementById('mistral-key').value.trim();
    const config = {
        active_provider: "mistral",
        mistral: { url, api_key }
    };
    console.log("Envoi config Mistral:", config);
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const res = await fetch('/api/save_ia_config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(config)
    });
    if (res.ok) {
        document.getElementById('status').innerText = '{{ labels['mistral_config_saved'] }}';
    } else {
        document.getElementById('status').innerText = '{{ labels['save_error'] }}';
    }
}

async function refreshOllama() {
    const url = document.getElementById('ollama-url').value.trim();
    const config = {
        active_provider: "ollama",
        ollama: { url, model: "" }
    };
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const res = await fetch('/api/save_ia_config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(config)
    });
    if (res.ok) {
        document.getElementById('status').innerText = '{{ labels['ollama_url_saved'] }}';
        await detectOllama();
    } else {
        document.getElementById('status').innerText = 'Erreur lors de l\'enregistrement.';
    }
}

detectOllama();

document.getElementById('send-btn').addEventListener('click', async () => {
    const userInput = document.getElementById('user-input').value.trim();
    if (!userInput) return;

    const responseDiv = document.getElementById('response');
    responseDiv.textContent = "";

    try {
        const res = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: userInput })
        });

        if (!res.ok) {
            responseDiv.textContent = "{{ labels['server_error'] }}: " + res.status;
            return;
        }

        const data = await res.json();
        if (data.error) {
            responseDiv.textContent = "{{ labels['error'] }}: " + data.error;
        } else {
            responseDiv.innerHTML = marked.parse(data.response || "{{ labels['no_response'] }}");
        }
    } catch (error) {
        responseDiv.textContent = "{{ labels['error'] }}: " + error.message;
    }
});
async function pullOllamaModel() {
    const modelName = document.getElementById('ollama-pull-model').value.trim();
    if (!modelName) {
        document.getElementById('status').innerText = '{{ labels['enter_model_name'] }}';
        return;
    }
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    try {
        const res = await fetch('/api/ollama_pull', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ model_name: modelName })
        });
        const data = await res.json();
        if (res.ok && data.success) {
            document.getElementById('status').innerText = '{{ labels['model_downloaded'] }}';
            await detectOllama();
        } else {
            document.getElementById('status').innerText = '{{ labels['error'] }}: ' + (data.error || '{{ labels['unknown_error'] }}');
        }
    } catch (e) {
        document.getElementById('status').innerText = '{{ labels['error'] }}: ' + e.message;
    }
}

</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}
